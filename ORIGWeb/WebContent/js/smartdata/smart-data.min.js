$(function(t){"use strict";var a="smartData",e="wheel mousewheel DOMMouseScroll",i="focus click",o="mousedown",s="click";function n(a,e){if(t.isPlainObject(a)){var i=e.container,s=t(".img-controller",i).html("");if(a.zoomBar){var n=t('<div class="slider">'),r=e.defaultRatio,l={value:20,slide:function(t,a){var i=(a.value-20)/10*r;e.zoom(r+i)}};n.slider(l),n.appendTo(s)}if(a.zoomIn){var c=t('<div class="zoom-in">'),h=t('<button type="button" data-method="zoomIn"><i class="fa fa-plus fa-fw"/></button>');c.append(h).appendTo(s)}if(a.zoomOut){var d=t('<div class="zoom-out">');h=t('<button type="button" data-method="zoomOut"><i class="fa fa-minus fa-fw"/></button>');d.append(h).appendTo(s)}if(a.reset){var m=t('<div class="rotate90">');h=t('<button type="button" data-method="reset"><i class="fa fa-refresh fa-fw"/></button>');m.append(h).appendTo(s)}if(a.rotate90){var p=t('<div class="rotate90">');h=t('<button type="button"  data-method="rotate" data-option="90"><i class="fa fa-rotate-right fa-fw"/>90</button>');p.append(h).appendTo(s)}if(a.rotate_90){p=t('<div class="rotate-90">'),h=t('<button type="button" data-method="rotate" data-option="-90"><i class="fa fa-rotate-left fa-fw"/>-90</button>');p.append(h).appendTo(s)}if(a.rotate180){p=t('<div class="rotate180">'),h=t('<button type="button" data-method="rotate" data-option="180"><i class="fa fa-rotate-right fa-fw"/>180</button>');p.append(h).appendTo(s)}if(a.lock){p=t('<div class="lock unlocked">'),h=t('<button type="button"><i class="fa fa-unlock fa-fw"/></button>');p.append(h).appendTo(s),h.on(o,function(t){t.preventDefault(),e.toggleLock.call(e)})}var f=t('<div class="print">'),u=t('<button type="button"><i class="fa fa-print fa-fw"/></button>');return a.print&&u.click(function(){"true"==t(".thumbnail-widget.active",i).attr("data-printable")&&function(t,a){if(t&&t.length){var e=t.clone().css({width:"645px",height:"auto"})[0].outerHTML,i="toolbar=yes,location=no,directories=yes,menubar=yes,";i+="scrollbars=yes,width=800, height=800, left=50, top=25,_blank","Microsoft Internet Explorer"!=navigator.appName&&(i="");var o=window.open("","",i);o.document.open(),o.document.write('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html>'),o.document.write("<head><title></title>"),o.document.write("<style> .col-sm-6{ width:50%;  float: left;} .smart-background{ position: absolute;  z-index: 500;  top: -25px;  width: 100%;} .smart-watermark-text{\tposition: relative;\ttop: 0; \tz-index: 500;\t-webkit-transform:rotate(330deg);\ttransform:rotate(330deg);\t-moz-transform:rotate(330deg);\tcolor: lightgrey;\topacity:0.4;\tfont-size: 90px;\tmargin-left: -3%; \tdisplay: block;}.smart-watermark{\tline-height: 240px;\ttext-align: center;}.smart-watermark-text::after{\tcontent: attr(data-bg-text);} </style>"),o.document.write('<script> function onloadSmartPopupBlackground() { var htmlText = document.getElementById("smart-back").innerHTML;\tdocument.getElementById("smart-back").innerHTML = "";\tfor(var j=0;j<4;j++){\tfor(var i=0;i<2;i++){\tdocument.getElementById("smart-back").innerHTML += htmlText; }}} <\/script>'),o.document.write('</head><body style="padding:0;margin-top:0 !important;margin-bottom:0!important;"  onLoad="onloadSmartPopupBlackground();self.print();self.close();">'),o.document.write('<div class="smart-background" id="smart-back" ><div class="col-sm-6 smart-watermark"><span class="smart-watermark-text" data-bg-text="'+USER_ID.toUpperCase()+'" ></span></div></div>'),o.document.write(e),o.document.write("</body></html>"),o.document.close(),o.focus()}}(e.image)}),f.append(u).appendTo(s),s}}function r(a,e){this.$element=t(a),this.options=t.extend({},r.DEFAULTS,t.isPlainObject(e)&&e),this.defaultRatio=1,this.currentRatio=1,this.isRotated=!1,this.isLocked=!1,this.isBuilt=!1,this.wheeling=!1,this.container=null,this.imageContainer=null,this.controllerContainer=null,this.thumbnailContainer=null,this.image=null,this.canvas=null,this.decorator=null,this.selectBox=null,this.eventTagId=null,this.init()}r.prototype={constructor:r,init:function(){this.build(),this.bind()},build:function(){this.isBuilt=!1;var a=this.container=this.$element.html(r.TEMPLATE);this.canvas=t(".img-canvas",a),this.image=t(".main-image",a),this.imageContainer=t(".img-container",a),this.decorator=t(".img-decorator",a),this.selectBox=t(".select-box",a),this.controllerContainer=n(this.options.controller,this),this.thumbnailContainer=function(a,e){if(!a||!a.length)return null;for(var i=e.container,o=t(".thumbnail-container",i).html(""),s=t('<div class="thumbnail-cache">').appendTo(o).hide(),n=0,r=a.length;n<r;n++){var l=a[n],c=t('<div class="thumbnail-widget"><div class="header"></div><div class="body"><img class="thumbnail-img" style="width:100%"/></div><div class="footer"><span class="personal-type"></span><span class="page-no"></span></div></div>');c.attr("data-page-no",l.pageNo),c.attr("data-printable",l.printable),c.attr("data-src",l.url),c.find(".thumbnail-img").attr("src",l.thumbnailUrl);var h=t("<span>").text(l.docTypeDesc);c.find(".header").append(h),c.find(".page-no").text(n+1),c.find(".personal-type").text(l.personalTypeDesc),o.append(c),t("<img>").attr("src",l.url).appendTo(s)}return o}(this.options.images,this),this.setImageByPageNo(this.options.images&&this.options.images[0]&&this.options.images[0].pageNo),this.isBuilt=!0},reset:function(){var t,a,e,i,o,s,n=this.image,r=this.canvas;t=n.data("archetypeWidth")||n.width()||2480,a=n.data("archetypeHeight")||n.height()||3507,i=this.imageContainer.height()||669,e=this.imageContainer.width()||723,s=t<a?(e-t*(o=e/t))/2:(i-a*(o=i/a))/2,r.css({transform:"scale("+o+","+o+")",left:s,top:"0px"}),this.defaultRatio=o,this.rotate(),this.hideDecorator()},bind:function(){var a=this,o=this.options;this.canvas.draggable({disabled:!1}),this.imageContainer.on(e,t.proxy(this.wheel,this)),this.thumbnailContainer.on(s,".thumbnail-widget",function(){var e=t(this),i=parseInt(e.attr("data-page-no"));a.setImageByPageNo(i)}),o.smartField&&t(document).on(i,o.smartField,function(e){a.smartField(t(this))}),this.controllerContainer.on(s,"[data-method]",function(e){e.preventDefault();var i=t(this).data(),o=a[i.method];t.isFunction(o)&&o.call(a,i.option)})},unbind:function(){var a=this.options;this.canvas.draggable("disable"),this.imageContainer.off(e),this.thumbnailContainer.off(s,".thumbnail-widget"),a.smartField&&t(document).off(i,a.smartField),this.controllerContainer.off(s)},hideDecorator:function(){var t=this.decorator,a=this.image&&!this.image.hasClass("locked");t&&a&&t.hide()},showDecorator:function(){var t=this.decorator;t&&t.show()},setImageByPageNo:function(a,e){var i=this,o=this.image;if(a==parseInt(o.attr("data-page-no")))return this.rotate(),e&&(i.setCanvasData(e.canvas),i.setSelectBoxData(e.selectBox)),!0;var s=function(t,a){if(!t||!t.length||0!=a&&"0"!=a&&!a)return null;for(var e=0,i=t.length;e<i;e++){var o=t[e];if(o&&o.pageNo==parseInt(a))return o}return null}(this.options.images,a);return s?(t(o).attr("src",s.url).load(function(){s.archetypeWidth&&s.archetypeHeight||(s.archetypeWidth=this.naturalWidth,s.archetypeHeight=this.naturalHeight),o.attr("data-page-no",a).data({archetypeWidth:s.archetypeWidth,archetypeHeight:s.archetypeHeight}),o.css({width:s.archetypeWidth,height:s.archetypeHeight}),i.setThumbnailByPageNo(a),i.reset(),e&&(i.setCanvasData(e.canvas),i.setSelectBoxData(e.selectBox))}),!0):(this.hideDecorator(),!1)},setThumbnailByPageNo:function(a){if(0==a||a){var e=t('.thumbnail-container [data-page-no="'+a+'"]');if(e.length){e.siblings().removeClass("active"),e.addClass("active");var i=t(".thumbnail-container").scrollLeft(0),o=i.width(),s=i.offset().left,n=e.width(),r=e.offset().left-(o/2-n/2)-s;i.scrollLeft(r)}}},getCanvasData:function(){var t=this.canvas,a=function(t){var a=t.css("-webkit-transform")||t.css("-moz-transform")||t.css("-ms-transform")||t.css("-o-transform")||t.css("transform");if("none"!==a){var e=a.match(/matrix\((-?\d*\.?\d+),\s*0,\s*0,\s*(-?\d*\.?\d+),\s*0,\s*0\)/);if(e&&e.length)return{scaleX:e[1],scaleY:e[2]}}return{}}(t),e={};return e.width=t.width(),e.height=t.height(),e.scaleX=a.scaleX,e.scaleY=a.scaleY,e},setCanvasData:function(t){if(t){var a=this.canvas,e=this.image,i=e.data("archetypeWidth")||e.width()||800,o=t.width/i,s=t.left,n=t.top;o&&a.css({transform:"scale("+o+","+o+")",left:s+"px",top:n+"px"})}},getSelectBoxData:function(){return"Not supported yet"},setSelectBoxData:function(t){if(t&&t.width&&t.height){var a=this.decorator,e=this.getCanvasData(),i=this.selectBox,o=e.scaleX,s=this.options.selectBoxStrokeWidth;i.attr("x",t.x),i.attr("y",t.y),i.attr("width",t.width),i.attr("height",t.height),i.attr("stroke-width",parseInt(s/o)),a.show()}},smartField:function(a){var e=t(a).attr("id")||t(a).closest(".selectize-control").siblings(":input:first").attr("id");this.eventTagId=e,console.log("smartField : "+e),this.hideDecorator(),a&&this.options.sensitiveSmartField&&t(a).one("blur",t.proxy(this.hideDecorator,this)),e&&this.smartFieldById(e)},smartFieldById:function(t){if(t){var a=this.options.fields;if(a){var e=a[t];e&&(e.pageNo?this.setImageByPageNo(e.pageNo,e):this.rotate())}}},rotate:function(t){"string"==typeof t&&(t=parseInt(dec)),"number"!=typeof t&&(t=0);var a=this.image,e=this.decorator;if(!t)return a.css("transform","rotate(0deg)"),void e.css("transform","rotate(0deg)");var i=(function(t){var a=t.css("-webkit-transform")||t.css("-moz-transform")||t.css("-ms-transform")||t.css("-o-transform")||t.css("transform"),e=0;if("none"!==a){var i=a.split("(")[1].split(")")[0].split(","),o=i[0],s=i[1];e=Math.round(Math.atan2(s,o)*(180/Math.PI))}else e=0;return e<0?e+360:e}(a)||0)+t;this.isRotated=i%360!=0,a.css("transform","rotate("+i+"deg)"),e.css("transform","rotate("+i+"deg)")},wheel:function(a){a.preventDefault();var e,i=a.originalEvent,o=this.options,s=0;this.wheeling||(this.wheeling=!0,setTimeout(t.proxy(function(){this.wheeling=!1},this),50),i&&(s=i.deltaY<0?1:-1),e=1+s*o.wheelZoomRatio,this.zoomTo(e,a))},zoomIn:function(){this.zoomTo(1+this.options.wheelZoomRatio)},zoomOut:function(){this.zoomTo(1-this.options.wheelZoomRatio)},zoomTo:function(t,a){var e=this.getCanvasData(),i=e.width,o=i*e.scaleX*t/i;this.zoom(o,a)},zoom:function(t,a){var e,i,o,s,n,r,l=this.options,c=this.canvas,h=this.getCanvasData(),d=h.width,m=h.height,p=null,f=d*h.scaleX,u=m*h.scaleY;if(t>l.maxZoomRatio)return!1;if(t<l.minZoomRatio)return!1;e=d*t,i=m*t,a&&(p=a.originalEvent);var g=c.position();n=g.left,r=g.top,p?(o=this.imageContainer.offset(),n-=(e-f)*(((s={pageX:a.pageX||p.pageX||0,pageY:a.pageY||p.pageY||0,offsetX:a.offsetX||p.offsetX||0,offsetY:a.offsetY||p.offsetY||0}).pageX-o.left-n)/f),r-=(i-u)*((s.pageY-o.top-r)/u)):(n-=(e-f)/2,r-=(i-u)/2),c.css({transform:"scale("+t+","+t+")",left:n+"px",top:r+"px"}),this.currentRatio=t},getDefaultRatio:function(){return this.defaultRatio},toggleLock:function(){this.container;var a=this.image;this.selectBox,this.canvas;this.isLocked?(this.bind(),a.removeClass("locked"),this.isLocked=!1):(this.unbind(),a.addClass("locked"),this.isLocked=!0);var e=this.controllerContainer.find(".lock button");e.toggleClass("locked unlocked"),t(".fa",e).toggleClass("fa-lock fa-unlock")}},r.DEFAULTS={images:[{pageNo:1,url:"images/app_form_p1.png",thumbnailUrl:"images/17ffed2060072c95583b3844da54540f3b8649ee9b42497abe8f4aaa3a14078c.png",archetypeWidth:2480,archetypeHeight:3507}],fields:{max_education:{pageNo:1,canvas:{left:37.495926726444495,top:-302.88849580214503,width:1259.7098453477524,height:1781.371946626842,naturalWidth:2480,naturalHeight:3507},selectBox:{x:99.51194376111553,y:928.2228553723241,width:1100.3389851915076,height:52.76135631189906,rotate:0,scaleX:1,scaleY:1}}},controller:{zoomBar:!1,zoomIn:!0,zoomOut:!0,reset:!0,rotate90:!0,rotate_90:!0,rotate180:!0,lock:!0,print:!0},smartField:":input:not(button)",sensitiveSmartField:!0,wheelZoomRatio:.2,maxZoomRatio:5,minZoomRatio:.05,selectBoxStrokeWidth:4,containerHeight:700},r.TEMPLATE=t('<div class="smart-container"><div class="img-container"><div class="img-canvas"><img class="main-image" src=""/><svg class="img-decorator" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" baseProfile="basic" xml:space="preserve" xmlns:xml="http://www.w3.org/XML/1998/namespace"><rect class="select-box" x="40" y="210" width="900" height="60" style="fill:transparent;stroke:red;stroke-width:4;stroke-opacity:0.3"></svg></div></div><div class="img-controller"></div><div class="thumbnail-container"></div></div>'),t.fn.smartData=function(e){var i,o,s,n=(i=arguments,s=[],"number"==typeof(o=1)&&s.push(o),s.slice.apply(i,s)),l=null;return this.each(function(){var i,o,s=t(this),c=s.data(a);c||(i=t.extend({},s.data(),t.isPlainObject(e)&&e),s.data(a,c=new r(this,i))),"string"==typeof e&&t.isFunction(o=c[e])&&(l=o.apply(c,n))}),void 0===l?this:l}});